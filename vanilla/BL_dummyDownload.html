<!DOCTYPE html>
<input type="file" id="myFile">Load image</input>
<br>
<button id="download" type="button">Download!</button>
<br>
<canvas id="myCanvas"></canvas>
 

<script>
let imageWidth
let imageHeight
let filename

document.getElementById("download").onclick = function () {
    let ctx = document.getElementById("myCanvas").getContext("2d")
    let imageData = ctx.getImageData(0, 0, imageWidth, imageHeight).data
    let channel = imageData.length / imageWidth / imageHeight

    let channelData = []
    let channelDataStr = []
    imageData.forEach((x, index) => { if (index % channel === 0) { channelData.push(x) } })
    while (channelData.length) {
        channelDataStr.push(channelData.splice(0, imageWidth))
    }
    channelDataStr = "data:text/csv;charset=utf-8," + channelDataStr.map(x => x.join(",")).join("\n")
    dummyDownload(channelDataStr, filename)
}

document.getElementById('myFile').onchange = function (evt) {
    let tgt = evt.target || evt.srcElement
    let files = tgt.files
    filename = files[0].name
    // files[0].type.indexOf('image') !== -1
    if (FileReader && files && files.length) {
        let fr = new FileReader()
        fr.readAsDataURL(files[0])
        fr.onload = function (evt) {
            let img = new Image()
            img.src = evt.target.result
            img.onload = function () {
                imagetoCanvas(this)
            }
        }
    }
}

function dummyDownload(csvContent, fn) {
    let encodedUri = encodeURI(csvContent);
    let link = document.createElement("a")
    link.setAttribute("href", encodedUri)
    link.setAttribute("download", fn + ".csv")
    link.style.visibility = 'hidden'
    document.body.appendChild(link)

    link.click()
}

function imagetoCanvas(img) {
    let canvas = document.getElementById("myCanvas")
    let ctx = canvas.getContext("2d")
    imageWidth = img.width
    imageHeight = img.height
    canvas.width = imageWidth
    canvas.height = imageHeight
    ctx.drawImage(img, 0, 0)
    imageData = ctx.getImageData(0, 0, imageWidth, imageHeight)
}
</script>
